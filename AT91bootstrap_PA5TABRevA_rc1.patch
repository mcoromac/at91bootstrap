From 7bf31ab05ed9c989d5e6028a2604531a7fa700db Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Adam=20Rudzi=C5=84ski?= <devel@arf.net.pl>
Date: Tue, 10 Oct 2017 22:25:26 +0200
Subject: [PATCH 1/4] P-A5-TAB RevA port

---
 contrib/board/Config.in.board                      |   1 +
 contrib/board/Config.in.boardname                  |   1 +
 contrib/board/p_a5_tab_reva/Config.in.board        |  14 +
 contrib/board/p_a5_tab_reva/Config.in.boardname    |   2 +
 contrib/board/p_a5_tab_reva/board.mk               |   2 +
 contrib/board/p_a5_tab_reva/p_a5_tab_reva.c        | 392 +++++++++++++++++++++
 contrib/board/p_a5_tab_reva/p_a5_tab_reva.h        |  46 +++
 .../p_a5_tab_reva/p_a5_tab_revaemmc_defconfig      |  10 +
 contrib/include/contrib_board.h                    |   4 +
 9 files changed, 472 insertions(+)
 create mode 100644 contrib/board/p_a5_tab_reva/Config.in.board
 create mode 100644 contrib/board/p_a5_tab_reva/Config.in.boardname
 create mode 100644 contrib/board/p_a5_tab_reva/board.mk
 create mode 100644 contrib/board/p_a5_tab_reva/p_a5_tab_reva.c
 create mode 100644 contrib/board/p_a5_tab_reva/p_a5_tab_reva.h
 create mode 100644 contrib/board/p_a5_tab_reva/p_a5_tab_revaemmc_defconfig

diff --git a/contrib/board/Config.in.board b/contrib/board/Config.in.board
index 2c67225..a12037c 100644
--- a/contrib/board/Config.in.board
+++ b/contrib/board/Config.in.board
@@ -8,3 +8,4 @@ source "contrib/board/acme/sama5d3_acqua/Config.in.board"
 source "contrib/board/acme/sama5d2_roadrunner/Config.in.board"
 source "contrib/board/corewind/core9g25/Config.in.board"
 source "contrib/board/axentia/sama5d3_linea/Config.in.board"
+source "contrib/board/p_a5_tab_reva/Config.in.board"
diff --git a/contrib/board/Config.in.boardname b/contrib/board/Config.in.boardname
index fe843fe..c8ed3f9 100644
--- a/contrib/board/Config.in.boardname
+++ b/contrib/board/Config.in.boardname
@@ -8,3 +8,4 @@ source "contrib/board/acme/sama5d3_acqua/Config.in.boardname"
 source "contrib/board/acme/sama5d2_roadrunner/Config.in.boardname"
 source "contrib/board/corewind/core9g25/Config.in.boardname"
 source "contrib/board/axentia/sama5d3_linea/Config.in.boardname"
+source "contrib/board/p_a5_tab_reva/Config.in.boardname"
diff --git a/contrib/board/p_a5_tab_reva/Config.in.board b/contrib/board/p_a5_tab_reva/Config.in.board
new file mode 100644
index 0000000..3b75f90
--- /dev/null
+++ b/contrib/board/p_a5_tab_reva/Config.in.board
@@ -0,0 +1,14 @@
+config CONFIG_P_A5_TAB_REVA
+	bool "p_a5_tab_reva"
+	select SAMA5D2
+	select CONFIG_CPU_V7
+	select CONFIG_DDRC
+	select ALLOW_SDCARD
+	select ALLOW_CPU_CLK_348MHZ
+	select ALLOW_CPU_CLK_498MHZ
+	select ALLOW_CRYSTAL_12_000MHZ
+	select CONFIG_HAS_PMIC_ACT8865
+	select SUPPORT_BUS_SPEED_116MHZ
+	select SUPPORT_BUS_SPEED_166MHZ
+	help
+		Use the P-A5-TAB RevA board
diff --git a/contrib/board/p_a5_tab_reva/Config.in.boardname b/contrib/board/p_a5_tab_reva/Config.in.boardname
new file mode 100644
index 0000000..f2cc9e8
--- /dev/null
+++ b/contrib/board/p_a5_tab_reva/Config.in.boardname
@@ -0,0 +1,2 @@
+config CONFIG_BOARDNAME
+	default "p_a5_tab_reva"		if CONFIG_P_A5_TAB_REVA
diff --git a/contrib/board/p_a5_tab_reva/board.mk b/contrib/board/p_a5_tab_reva/board.mk
new file mode 100644
index 0000000..ca5957f
--- /dev/null
+++ b/contrib/board/p_a5_tab_reva/board.mk
@@ -0,0 +1,2 @@
+CPPFLAGS += -DCONFIG_P_A5_TAB_REVA
+ASFLAGS += -DCONFIG_P_A5_TAB_REVA
diff --git a/contrib/board/p_a5_tab_reva/p_a5_tab_reva.c b/contrib/board/p_a5_tab_reva/p_a5_tab_reva.c
new file mode 100644
index 0000000..cb6097d
--- /dev/null
+++ b/contrib/board/p_a5_tab_reva/p_a5_tab_reva.c
@@ -0,0 +1,392 @@
+#include "p_a5_tab_reva.h"
+#include "common.h"
+#include "ddramc.h"
+#include "gpio.h"
+#include "hardware.h"
+#include "l2cc.h"
+#include "matrix.h"
+#include "pmc.h"
+#include "timer.h"
+#include "twi.h"
+#include "usart.h"
+#include "watchdog.h"
+#include "arch/at91_ddrsdrc.h"
+#include "arch/at91_pio.h"
+#include "arch/at91_pmc.h"
+#include "arch/at91_rstc.h"
+#include "arch/tz_matrix.h"
+
+
+static void at91_dbgu_hw_init(void)
+{
+	const struct pio_desc dbgu_pins[] = {
+		{"RXD1", CONFIG_SYS_DBGU_RXD_PIN, 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"TXD1", CONFIG_SYS_DBGU_TXD_PIN, 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
+	};
+
+	pmc_sam9x5_enable_periph_clk(CONFIG_SYS_DBGU_ID);
+	*(volatile unsigned int*)AT91C_BASE_FLEXCOM1 = 1;
+	pio_configure(dbgu_pins);
+}
+
+static void initialize_dbgu(void)
+{
+	unsigned int baudrate = 9600;
+
+	at91_dbgu_hw_init();
+
+	if (pmc_check_mck_h32mxdiv())
+		usart_init(BAUDRATE(MASTER_CLOCK / 2, baudrate));
+	else
+		usart_init(BAUDRATE(MASTER_CLOCK, baudrate));
+}
+
+#if defined(CONFIG_MATRIX)
+static int matrix_configure_slave(void)
+{
+	unsigned int ddr_port;
+	unsigned int ssr_setting, sasplit_setting, srtop_setting;
+
+	/*
+	 * Matrix 0 (H64MX)
+	 */
+
+	/*
+	 * 0: Bridge from H64MX to AXIMX
+	 * (Internal ROM, Crypto Library, PKCC RAM): Always Secured
+	 */
+
+	/* 1: H64MX Peripheral Bridge */
+
+	/* 2 ~ 9 DDR2 Port1 ~ 7: Non-Secure */
+	srtop_setting = MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_128M);
+	sasplit_setting = (MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_128M)
+				| MATRIX_SASPLIT(1, MATRIX_SASPLIT_VALUE_128M)
+				| MATRIX_SASPLIT(2, MATRIX_SASPLIT_VALUE_128M)
+				| MATRIX_SASPLIT(3, MATRIX_SASPLIT_VALUE_128M));
+	ssr_setting = (MATRIX_LANSECH_NS(0)
+			| MATRIX_LANSECH_NS(1)
+			| MATRIX_LANSECH_NS(2)
+			| MATRIX_LANSECH_NS(3)
+			| MATRIX_RDNSECH_NS(0)
+			| MATRIX_RDNSECH_NS(1)
+			| MATRIX_RDNSECH_NS(2)
+			| MATRIX_RDNSECH_NS(3)
+			| MATRIX_WRNSECH_NS(0)
+			| MATRIX_WRNSECH_NS(1)
+			| MATRIX_WRNSECH_NS(2)
+			| MATRIX_WRNSECH_NS(3));
+	/* DDR port 0 not used from NWd */
+	for (ddr_port = 1; ddr_port < 8; ddr_port++) {
+		matrix_configure_slave_security(AT91C_BASE_MATRIX64,
+					(H64MX_SLAVE_DDR2_PORT_0 + ddr_port),
+					srtop_setting,
+					sasplit_setting,
+					ssr_setting);
+	}
+
+	/*
+	 * 10: Internal SRAM 128K
+	 * TOP0 is set to 128K
+	 * SPLIT0 is set to 64K
+	 * LANSECH0 is set to 0, the low area of region 0 is the Securable one
+	 * RDNSECH0 is set to 0, region 0 Securable area is secured for reads.
+	 * WRNSECH0 is set to 0, region 0 Securable area is secured for writes
+	 */
+	srtop_setting = MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_128K);
+	sasplit_setting = MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_64K);
+	ssr_setting = (MATRIX_LANSECH_S(0)
+			| MATRIX_RDNSECH_S(0)
+			| MATRIX_WRNSECH_S(0));
+	matrix_configure_slave_security(AT91C_BASE_MATRIX64,
+					H64MX_SLAVE_INTERNAL_SRAM,
+					srtop_setting,
+					sasplit_setting,
+					ssr_setting);
+
+	/* 11:  Internal SRAM 128K (Cache L2) */
+	/* 12:  QSPI0 */
+	/* 13:  QSPI1 */
+	/* 14:  AESB */
+
+	/*
+	 * Matrix 1 (H32MX)
+	 */
+
+	/* 0: Bridge from H32MX to H64MX: Not Secured */
+
+	/* 1: H32MX Peripheral Bridge 0: Not Secured */
+
+	/* 2: H32MX Peripheral Bridge 1: Not Secured */
+
+	/*
+	 * 3: External Bus Interface
+	 * EBI CS0 Memory(256M) ----> Slave Region 0, 1
+	 * EBI CS1 Memory(256M) ----> Slave Region 2, 3
+	 * EBI CS2 Memory(256M) ----> Slave Region 4, 5
+	 * EBI CS3 Memory(128M) ----> Slave Region 6
+	 * NFC Command Registers(128M) -->Slave Region 7
+	 *
+	 * NANDFlash(EBI CS3) --> Slave Region 6: Non-Secure
+	 */
+	srtop_setting =	MATRIX_SRTOP(6, MATRIX_SRTOP_VALUE_128M);
+	srtop_setting |= MATRIX_SRTOP(7, MATRIX_SRTOP_VALUE_128M);
+	sasplit_setting = MATRIX_SASPLIT(6, MATRIX_SASPLIT_VALUE_128M);
+	sasplit_setting |= MATRIX_SASPLIT(7, MATRIX_SASPLIT_VALUE_128M);
+	ssr_setting = (MATRIX_LANSECH_NS(6)
+			| MATRIX_RDNSECH_NS(6)
+			| MATRIX_WRNSECH_NS(6));
+	ssr_setting |= (MATRIX_LANSECH_NS(7)
+			| MATRIX_RDNSECH_NS(7)
+			| MATRIX_WRNSECH_NS(7));
+	matrix_configure_slave_security(AT91C_BASE_MATRIX32,
+					H32MX_EXTERNAL_EBI,
+					srtop_setting,
+					sasplit_setting,
+					ssr_setting);
+
+	/* 4: NFC SRAM (4K): Non-Secure */
+	srtop_setting = MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_8K);
+	sasplit_setting = MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_8K);
+	ssr_setting = (MATRIX_LANSECH_NS(0)
+			| MATRIX_RDNSECH_NS(0)
+			| MATRIX_WRNSECH_NS(0));
+	matrix_configure_slave_security(AT91C_BASE_MATRIX32,
+					H32MX_NFC_SRAM,
+					srtop_setting,
+					sasplit_setting,
+					ssr_setting);
+
+	/* 5:
+	 * USB Device High Speed Dual Port RAM (DPR): 1M
+	 * USB Host OHCI registers: 1M
+	 * USB Host EHCI registers: 1M
+	 */
+	srtop_setting = (MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_1M)
+			| MATRIX_SRTOP(1, MATRIX_SRTOP_VALUE_1M)
+			| MATRIX_SRTOP(2, MATRIX_SRTOP_VALUE_1M));
+	sasplit_setting = (MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_1M)
+			| MATRIX_SASPLIT(1, MATRIX_SASPLIT_VALUE_1M)
+			| MATRIX_SASPLIT(2, MATRIX_SASPLIT_VALUE_1M));
+	ssr_setting = (MATRIX_LANSECH_NS(0)
+			| MATRIX_LANSECH_NS(1)
+			| MATRIX_LANSECH_NS(2)
+			| MATRIX_RDNSECH_NS(0)
+			| MATRIX_RDNSECH_NS(1)
+			| MATRIX_RDNSECH_NS(2)
+			| MATRIX_WRNSECH_NS(0)
+			| MATRIX_WRNSECH_NS(1)
+			| MATRIX_WRNSECH_NS(2));
+	matrix_configure_slave_security(AT91C_BASE_MATRIX32,
+					H32MX_USB,
+					srtop_setting,
+					sasplit_setting,
+					ssr_setting);
+
+	return 0;
+}
+
+static unsigned int security_ps_peri_id[] = {
+	0,
+};
+
+static int matrix_config_periheral(void)
+{
+	unsigned int *peri_id = security_ps_peri_id;
+	unsigned int array_size = sizeof(security_ps_peri_id) / sizeof(unsigned int);
+	int ret;
+
+	ret = matrix_configure_peri_security(peri_id, array_size);
+	if (ret)
+		return -1;
+
+	return 0;
+}
+
+static int matrix_init(void)
+{
+	int ret;
+
+	matrix_write_protect_disable(AT91C_BASE_MATRIX64);
+	matrix_write_protect_disable(AT91C_BASE_MATRIX32);
+
+	ret = matrix_configure_slave();
+	if (ret)
+		return -1;
+
+	ret = matrix_config_periheral();
+	if (ret)
+		return -1;
+
+	return 0;
+}
+#endif
+
+static void ddramc_reg_config(struct ddramc_register* ddramc_config)
+{
+	ddramc_config->mdr = AT91C_DDRC2_DBW_16_BITS |
+			     AT91C_DDRC2_MD_DDR2_SDRAM;
+
+	ddramc_config->cr = AT91C_DDRC2_NC_DDR10_SDR9 |
+			    AT91C_DDRC2_NR_13 |
+			    AT91C_DDRC2_CAS_3 |
+			    AT91C_DDRC2_DISABLE_RESET_DLL |
+			    AT91C_DDRC2_WEAK_STRENGTH_RZQ7 |
+			    AT91C_DDRC2_ENABLE_DLL |
+			    AT91C_DDRC2_NB_BANKS_8 |
+			    AT91C_DDRC2_NDQS_ENABLED |
+			    AT91C_DDRC2_DECOD_INTERLEAVED |
+			    AT91C_DDRC2_UNAL_SUPPORTED;
+
+	ddramc_config->rtr = 0x388;
+
+	ddramc_config->t0pr = AT91C_DDRC2_TRAS_(7) |
+			      AT91C_DDRC2_TRCD_(3) |
+			      AT91C_DDRC2_TWR_(3) |
+			      AT91C_DDRC2_TRC_(9) |
+			      AT91C_DDRC2_TRP_(3) |
+			      AT91C_DDRC2_TRRD_(2) |
+			      AT91C_DDRC2_TWTR_(2) |
+			      AT91C_DDRC2_TMRD_(2);
+
+	ddramc_config->t1pr = AT91C_DDRC2_TRFC_(22) |
+			      AT91C_DDRC2_TXSNR_(23) |
+			      AT91C_DDRC2_TXSRD_(200) |
+			      AT91C_DDRC2_TXP_(2);
+
+	ddramc_config->t2pr = AT91C_DDRC2_TXARD_(2) |
+			      AT91C_DDRC2_TXARDS_(8) |
+			      AT91C_DDRC2_TRPA_(4) |
+			      AT91C_DDRC2_TRTP_(2) |
+			      AT91C_DDRC2_TFAW_(8);
+}
+
+
+static void ddramc_init(void)
+{
+	struct ddramc_register ddramc_reg;
+	unsigned int reg;
+
+	ddramc_reg_config(&ddramc_reg);
+
+	pmc_enable_periph_clock(AT91C_ID_MPDDRC);
+	pmc_enable_system_clock(AT91C_PMC_DDR);
+
+	reg = AT91C_MPDDRC_RD_DATA_PATH_ONE_CYCLES;
+	writel(reg, (AT91C_BASE_MPDDRC + MPDDRC_RD_DATA_PATH));
+
+	reg = readl(AT91C_BASE_MPDDRC + MPDDRC_IO_CALIBR);
+	reg &= ~AT91C_MPDDRC_RDIV;
+	reg &= ~AT91C_MPDDRC_TZQIO;
+	reg |= AT91C_MPDDRC_RDIV_DDR2_RZQ_50;
+	reg |= AT91C_MPDDRC_TZQIO_(101);
+	writel(reg, (AT91C_BASE_MPDDRC + MPDDRC_IO_CALIBR));
+
+	ddram_initialize(AT91C_BASE_MPDDRC, AT91C_BASE_DDRCS, &ddramc_reg);
+}
+
+#ifdef CONFIG_HW_INIT
+void hw_init(void)
+{
+	at91_disable_wdt();
+
+	pmc_cfg_mck_down(BOARD_PRESCALER_MAIN_CLOCK);
+	pmc_cfg_plla(PLLA_SETTINGS);
+	pmc_cfg_mck(BOARD_PRESCALER_PLLA);
+
+	writel(AT91C_RSTC_KEY_UNLOCK | AT91C_RSTC_URSTEN, AT91C_BASE_RSTC + RSTC_RMR);
+
+#if defined(CONFIG_MATRIX)
+	matrix_init();
+#endif
+
+	initialize_dbgu();
+	timer_init();
+	ddramc_init();
+	l2cache_prepare();
+}
+#endif
+
+#ifdef CONFIG_SDCARD
+#define ATMEL_SDHC_GCKDIV_VALUE		1
+
+void at91_sdhc_hw_init(void)
+{
+#ifdef CONFIG_SDHC0
+	const struct pio_desc sdmmc_pins[] = {
+		{"SDMMC0_CK",   AT91C_PIN_PA(0), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_CMD",  AT91C_PIN_PA(1), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT0", AT91C_PIN_PA(2), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT1", AT91C_PIN_PA(3), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT2", AT91C_PIN_PA(4), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT3", AT91C_PIN_PA(5), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT4", AT91C_PIN_PA(6), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT5", AT91C_PIN_PA(7), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT6", AT91C_PIN_PA(8), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT7", AT91C_PIN_PA(9), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_RSTN", AT91C_PIN_PA(10), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_VDDSEL", AT91C_PIN_PA(11), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_CD",   AT91C_PIN_PA(13), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
+	};
+#endif
+
+	pio_configure(sdmmc_pins);
+
+	pmc_sam9x5_enable_periph_clk(CONFIG_SYS_ID_SDHC);
+	pmc_enable_periph_generated_clk(CONFIG_SYS_ID_SDHC,
+					GCK_CSS_UPLL_CLK,
+					ATMEL_SDHC_GCKDIV_VALUE);
+}
+#endif
+
+#if defined(CONFIG_TWI0)
+unsigned int at91_twi0_hw_init(void)
+{
+	unsigned int base_addr = AT91C_BASE_TWI0;
+
+	const struct pio_desc twi_pins[] = {
+		{"TWD0", AT91C_PIN_PC(27), 0, PIO_DEFAULT, PIO_PERIPH_E},
+		{"TWCK0", AT91C_PIN_PC(28), 0, PIO_DEFAULT, PIO_PERIPH_E},
+		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
+	};
+
+	pio_configure(twi_pins);
+
+	pmc_sam9x5_enable_periph_clk(AT91C_ID_TWI0);
+
+	return base_addr;
+}
+#endif
+
+#if defined(CONFIG_TWI1)
+unsigned int at91_twi1_hw_init(void)
+{
+	const struct pio_desc twi_pins[] = {
+		{"TWD1", AT91C_PIN_PD(4), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"TWCK1", AT91C_PIN_PD(5), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
+	};
+
+	pio_configure(twi_pins);
+
+	pmc_sam9x5_enable_periph_clk(AT91C_ID_TWI1);
+
+	return AT91C_BASE_TWI1;
+}
+#endif
+
+#if defined(CONFIG_AUTOCONFIG_TWI_BUS)
+void at91_board_config_twi_bus(void)
+{
+	act8865_twi_bus = 0;
+}
+#endif
+
+#if defined(CONFIG_ACT8865_SET_VOLTAGE)
+int at91_board_act8865_set_reg_voltage(void)
+{
+	return 0;
+}
+#endif
diff --git a/contrib/board/p_a5_tab_reva/p_a5_tab_reva.h b/contrib/board/p_a5_tab_reva/p_a5_tab_reva.h
new file mode 100644
index 0000000..3bea9db
--- /dev/null
+++ b/contrib/board/p_a5_tab_reva/p_a5_tab_reva.h
@@ -0,0 +1,46 @@
+#ifndef __P_A5_TAB_REVA_H
+#define __P_A5_TAB_REVA_H
+
+
+#ifdef CONFIG_BUS_SPEED_166MHZ
+#define MASTER_CLOCK		166000000
+#define BOARD_PLLA_MULA		82
+#endif
+
+#ifdef CONFIG_BUS_SPEED_116MHZ
+#define MASTER_CLOCK		116000000
+#define BOARD_PLLA_MULA		57
+#endif
+
+
+#define BOARD_CKGR_PLLA		(AT91C_CKGR_SRCA | AT91C_CKGR_OUTA_0)
+#define BOARD_PLLACOUNT		(0x3F << 8)
+#define BOARD_MULA		((AT91C_CKGR_MULA << 2) & (BOARD_PLLA_MULA << 18))
+#define BOARD_DIVA		(AT91C_CKGR_DIVA & 1)
+
+#define BOARD_PRESCALER_MAIN_CLOCK	(AT91C_PMC_PLLADIV2_2 \
+					| AT91C_PMC_MDIV_3 \
+					| AT91C_PMC_CSS_MAIN_CLK)
+
+#define BOARD_PRESCALER_PLLA		(AT91C_PMC_H32MXDIV_H32MXDIV2 \
+					| AT91C_PMC_PLLADIV2_2 \
+					| AT91C_PMC_MDIV_3 \
+					| AT91C_PMC_CSS_PLLA_CLK)
+
+#define PLLA_SETTINGS		(BOARD_CKGR_PLLA | \
+				BOARD_PLLACOUNT | \
+				BOARD_MULA | \
+				BOARD_DIVA)
+
+
+#define USART_BASE			(AT91C_BASE_FLEXCOM1 + 0x0200)
+#define CONFIG_SYS_DBGU_RXD_PIN		AT91C_PIN_PA(23)
+#define CONFIG_SYS_DBGU_TXD_PIN		AT91C_PIN_PA(24)
+#define CONFIG_SYS_DBGU_ID		AT91C_ID_FLEXCOM1
+
+
+#define CONFIG_SYS_BASE_SDHC	AT91C_BASE_SDHC0
+#define CONFIG_SYS_ID_SDHC	AT91C_ID_SDMMC0
+
+
+#endif
diff --git a/contrib/board/p_a5_tab_reva/p_a5_tab_revaemmc_defconfig b/contrib/board/p_a5_tab_reva/p_a5_tab_revaemmc_defconfig
new file mode 100644
index 0000000..e4ef412
--- /dev/null
+++ b/contrib/board/p_a5_tab_reva/p_a5_tab_revaemmc_defconfig
@@ -0,0 +1,10 @@
+CONFIG_P_A5_TAB_REVA=y
+CONFIG_RAM_128MB=y
+CONFIG_DDR2=y
+CONFIG_SDCARD=y
+CONFIG_SDHC0=y
+CONFIG_DEBUG=y
+CONFIG_ACT8865=y
+CONFIG_PMIC_ON_TWI0=y
+# CONFIG_ENTER_NWD is not set
+# CONFIG_ACT8865_SET_VOLTAGE is not set
diff --git a/contrib/include/contrib_board.h b/contrib/include/contrib_board.h
index ad04326..b1df071 100644
--- a/contrib/include/contrib_board.h
+++ b/contrib/include/contrib_board.h
@@ -57,4 +57,8 @@
 #include "sama5d3_linea.h"
 #endif
 
+#ifdef CONFIG_P_A5_TAB_REVA
+#include "p_a5_tab_reva.h"
+#endif
+
 #endif
-- 
2.1.4


From 8182a275156cca9cf04148648d01b1cc9d4a27f0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Adam=20Rudzi=C5=84ski?= <devel@arf.net.pl>
Date: Thu, 12 Oct 2017 09:27:48 +0200
Subject: [PATCH 2/4] pins for progmode entry (not used now) reads from eMMC

---
 contrib/board/p_a5_tab_reva/p_a5_tab_reva.c | 53 +++++++++++++++++++++++++++--
 contrib/board/p_a5_tab_reva/p_a5_tab_reva.h |  4 +--
 driver/sdhc.c                               |  2 ++
 3 files changed, 55 insertions(+), 4 deletions(-)

diff --git a/contrib/board/p_a5_tab_reva/p_a5_tab_reva.c b/contrib/board/p_a5_tab_reva/p_a5_tab_reva.c
index cb6097d..49d8f18 100644
--- a/contrib/board/p_a5_tab_reva/p_a5_tab_reva.c
+++ b/contrib/board/p_a5_tab_reva/p_a5_tab_reva.c
@@ -1,6 +1,7 @@
 #include "p_a5_tab_reva.h"
 #include "common.h"
 #include "ddramc.h"
+#include "debug.h"
 #include "gpio.h"
 #include "hardware.h"
 #include "l2cc.h"
@@ -286,12 +287,41 @@ static void ddramc_init(void)
 	ddram_initialize(AT91C_BASE_MPDDRC, AT91C_BASE_DDRCS, &ddramc_reg);
 }
 
+
+/*static void init_prog_mode_hw(void)
+{
+	const struct pio_desc progmode_pins[] = {
+		{"PROGMODE_IN", AT91C_PIN_PD(26), 0, PIO_PULLUP, PIO_INPUT},
+		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
+	};
+
+	pio_configure(progmode_pins);
+}*/
+
+/*static void check_prog_mode_condition(void)
+{
+	if( pio_get_value(AT91C_PIN_PD(26)) )
+	{
+		dbg_info("--- NORMAL OPERATION ---\n");
+		return;
+	}
+
+	dbg_info("!!! I will now enter PROG MODE !!!\n");
+
+	*(volatile unsigned int*)0xF8045400 = (0xF << 12) | (1 << 11) | (1 << 10) | (3 << 8) | (3 << 6) | (3 << 4) | (3 << 2) | 3; //BUREG0
+	*(volatile unsigned int*)0xF8048054 = (0x6683 << 24) | (1 << 2) | 0; //BSC_CR
+	*(volatile unsigned int*)0xF8048000 = (0xA5 << 24) | 1; //reset
+	while(1);
+}*/
+
+
 #ifdef CONFIG_HW_INIT
 void hw_init(void)
 {
 	at91_disable_wdt();
 
-	pmc_cfg_mck_down(BOARD_PRESCALER_MAIN_CLOCK);
+//	init_prog_mode_hw();
+
 	pmc_cfg_plla(PLLA_SETTINGS);
 	pmc_cfg_mck(BOARD_PRESCALER_PLLA);
 
@@ -302,6 +332,8 @@ void hw_init(void)
 #endif
 
 	initialize_dbgu();
+//	check_prog_mode_condition();
+
 	timer_init();
 	ddramc_init();
 	l2cache_prepare();
@@ -311,6 +343,18 @@ void hw_init(void)
 #ifdef CONFIG_SDCARD
 #define ATMEL_SDHC_GCKDIV_VALUE		1
 
+#define SDMMC_CACR		(((volatile unsigned*)AT91C_BASE_SDHC0)[0x230/sizeof(unsigned)])
+#define SDMMC_CACR_UNLOCK_VAL	((0x46 << 8) | 1)
+#define SDMMC_CACR_LOCK_VAL	((0x46 << 8) | 0)
+
+#define SDMMC_CA0R		(((volatile unsigned*)AT91C_BASE_SDHC0)[0x40/sizeof(unsigned)])
+#define SDMMC_CA0R_SLTYPE(x)	((x) << 30)
+#define SDMMC_CA0R_SUP1V8	(1 << 26)
+#define SDMMC_CA0R_SUP3V3	(1 << 24)
+
+#define SDMMC_MC1R		(((volatile unsigned char*)AT91C_BASE_SDHC0)[0x204])
+#define SDMMC_MC1R_FCD		(1 << 7)
+
 void at91_sdhc_hw_init(void)
 {
 #ifdef CONFIG_SDHC0
@@ -327,7 +371,8 @@ void at91_sdhc_hw_init(void)
 		{"SDMMC0_DAT7", AT91C_PIN_PA(9), 0, PIO_DEFAULT, PIO_PERIPH_A},
 		{"SDMMC0_RSTN", AT91C_PIN_PA(10), 0, PIO_DEFAULT, PIO_PERIPH_A},
 		{"SDMMC0_VDDSEL", AT91C_PIN_PA(11), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_CD",   AT91C_PIN_PA(13), 0, PIO_DEFAULT, PIO_PERIPH_A},
+//		{"SDMMC0_WP",   AT91C_PIN_PA(12), 0, PIO_DEFAULT, PIO_PERIPH_A},
+//		{"SDMMC0_CD",   AT91C_PIN_PA(13), 0, PIO_DEFAULT, PIO_PERIPH_A},
 		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
 	};
 #endif
@@ -338,6 +383,10 @@ void at91_sdhc_hw_init(void)
 	pmc_enable_periph_generated_clk(CONFIG_SYS_ID_SDHC,
 					GCK_CSS_UPLL_CLK,
 					ATMEL_SDHC_GCKDIV_VALUE);
+	SDMMC_CACR = SDMMC_CACR_UNLOCK_VAL;
+	SDMMC_CA0R |= SDMMC_CA0R_SLTYPE(1) | SDMMC_CA0R_SUP1V8 | SDMMC_CA0R_SUP3V3;
+	SDMMC_CACR = SDMMC_CACR_LOCK_VAL;
+	SDMMC_MC1R |= SDMMC_MC1R_FCD;	//force CD for eMMC
 }
 #endif
 
diff --git a/contrib/board/p_a5_tab_reva/p_a5_tab_reva.h b/contrib/board/p_a5_tab_reva/p_a5_tab_reva.h
index 3bea9db..3c1a145 100644
--- a/contrib/board/p_a5_tab_reva/p_a5_tab_reva.h
+++ b/contrib/board/p_a5_tab_reva/p_a5_tab_reva.h
@@ -18,9 +18,9 @@
 #define BOARD_MULA		((AT91C_CKGR_MULA << 2) & (BOARD_PLLA_MULA << 18))
 #define BOARD_DIVA		(AT91C_CKGR_DIVA & 1)
 
-#define BOARD_PRESCALER_MAIN_CLOCK	(AT91C_PMC_PLLADIV2_2 \
+/*#define BOARD_PRESCALER_MAIN_CLOCK	(AT91C_PMC_PLLADIV2_2 \
 					| AT91C_PMC_MDIV_3 \
-					| AT91C_PMC_CSS_MAIN_CLK)
+					| AT91C_PMC_CSS_MAIN_CLK)*/
 
 #define BOARD_PRESCALER_PLLA		(AT91C_PMC_H32MXDIV_H32MXDIV2 \
 					| AT91C_PMC_PLLADIV2_2 \
diff --git a/driver/sdhc.c b/driver/sdhc.c
index 398f83c..12dcad2 100644
--- a/driver/sdhc.c
+++ b/driver/sdhc.c
@@ -519,8 +519,10 @@ exit:
 static int sdhc_init(struct sd_card *sdcard)
 {
 	unsigned int normal_status_mask, error_status_mask;
+	const unsigned int FCD_SETTING = sdhc_readb(SDMMC_MC1R) & SDMMC_MC1R_FCD;
 
 	sdhc_softare_reset();
+	if( FCD_SETTING ) { sdhc_writeb(SDMMC_MC1R, FCD_SETTING); }
 
 	sdhc_set_power();
 
-- 
2.1.4


From be4bb316eb6a656aa6e80d5d36677888d5e5fab6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Adam=20Rudzi=C5=84ski?= <devel@arf.net.pl>
Date: Sat, 3 Feb 2018 13:28:07 +0100
Subject: [PATCH 3/4] A.R.f. dir

---
 contrib/board/A.R.f./p_a5_tab_reva/Config.in.board |  14 +
 .../board/A.R.f./p_a5_tab_reva/Config.in.boardname |   2 +
 .../board/A.R.f./p_a5_tab_reva/Config.in.linux_arg |   0
 contrib/board/A.R.f./p_a5_tab_reva/board.mk        |   2 +
 contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.c | 441 +++++++++++++++++++++
 contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.h |  46 +++
 .../p_a5_tab_reva/p_a5_tab_revaemmc_defconfig      |  10 +
 contrib/board/Config.in.board                      |   2 +-
 contrib/board/Config.in.boardname                  |   2 +-
 contrib/board/Config.in.linux_arg                  |   1 +
 contrib/board/p_a5_tab_reva/Config.in.board        |  14 -
 contrib/board/p_a5_tab_reva/Config.in.boardname    |   2 -
 contrib/board/p_a5_tab_reva/board.mk               |   2 -
 contrib/board/p_a5_tab_reva/p_a5_tab_reva.c        | 441 ---------------------
 contrib/board/p_a5_tab_reva/p_a5_tab_reva.h        |  46 ---
 .../p_a5_tab_reva/p_a5_tab_revaemmc_defconfig      |  10 -
 16 files changed, 518 insertions(+), 517 deletions(-)
 create mode 100644 contrib/board/A.R.f./p_a5_tab_reva/Config.in.board
 create mode 100644 contrib/board/A.R.f./p_a5_tab_reva/Config.in.boardname
 create mode 100644 contrib/board/A.R.f./p_a5_tab_reva/Config.in.linux_arg
 create mode 100644 contrib/board/A.R.f./p_a5_tab_reva/board.mk
 create mode 100644 contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.c
 create mode 100644 contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.h
 create mode 100644 contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_revaemmc_defconfig
 delete mode 100644 contrib/board/p_a5_tab_reva/Config.in.board
 delete mode 100644 contrib/board/p_a5_tab_reva/Config.in.boardname
 delete mode 100644 contrib/board/p_a5_tab_reva/board.mk
 delete mode 100644 contrib/board/p_a5_tab_reva/p_a5_tab_reva.c
 delete mode 100644 contrib/board/p_a5_tab_reva/p_a5_tab_reva.h
 delete mode 100644 contrib/board/p_a5_tab_reva/p_a5_tab_revaemmc_defconfig

diff --git a/contrib/board/A.R.f./p_a5_tab_reva/Config.in.board b/contrib/board/A.R.f./p_a5_tab_reva/Config.in.board
new file mode 100644
index 0000000..3b75f90
--- /dev/null
+++ b/contrib/board/A.R.f./p_a5_tab_reva/Config.in.board
@@ -0,0 +1,14 @@
+config CONFIG_P_A5_TAB_REVA
+	bool "p_a5_tab_reva"
+	select SAMA5D2
+	select CONFIG_CPU_V7
+	select CONFIG_DDRC
+	select ALLOW_SDCARD
+	select ALLOW_CPU_CLK_348MHZ
+	select ALLOW_CPU_CLK_498MHZ
+	select ALLOW_CRYSTAL_12_000MHZ
+	select CONFIG_HAS_PMIC_ACT8865
+	select SUPPORT_BUS_SPEED_116MHZ
+	select SUPPORT_BUS_SPEED_166MHZ
+	help
+		Use the P-A5-TAB RevA board
diff --git a/contrib/board/A.R.f./p_a5_tab_reva/Config.in.boardname b/contrib/board/A.R.f./p_a5_tab_reva/Config.in.boardname
new file mode 100644
index 0000000..f2cc9e8
--- /dev/null
+++ b/contrib/board/A.R.f./p_a5_tab_reva/Config.in.boardname
@@ -0,0 +1,2 @@
+config CONFIG_BOARDNAME
+	default "p_a5_tab_reva"		if CONFIG_P_A5_TAB_REVA
diff --git a/contrib/board/A.R.f./p_a5_tab_reva/Config.in.linux_arg b/contrib/board/A.R.f./p_a5_tab_reva/Config.in.linux_arg
new file mode 100644
index 0000000..e69de29
diff --git a/contrib/board/A.R.f./p_a5_tab_reva/board.mk b/contrib/board/A.R.f./p_a5_tab_reva/board.mk
new file mode 100644
index 0000000..ca5957f
--- /dev/null
+++ b/contrib/board/A.R.f./p_a5_tab_reva/board.mk
@@ -0,0 +1,2 @@
+CPPFLAGS += -DCONFIG_P_A5_TAB_REVA
+ASFLAGS += -DCONFIG_P_A5_TAB_REVA
diff --git a/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.c b/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.c
new file mode 100644
index 0000000..49d8f18
--- /dev/null
+++ b/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.c
@@ -0,0 +1,441 @@
+#include "p_a5_tab_reva.h"
+#include "common.h"
+#include "ddramc.h"
+#include "debug.h"
+#include "gpio.h"
+#include "hardware.h"
+#include "l2cc.h"
+#include "matrix.h"
+#include "pmc.h"
+#include "timer.h"
+#include "twi.h"
+#include "usart.h"
+#include "watchdog.h"
+#include "arch/at91_ddrsdrc.h"
+#include "arch/at91_pio.h"
+#include "arch/at91_pmc.h"
+#include "arch/at91_rstc.h"
+#include "arch/tz_matrix.h"
+
+
+static void at91_dbgu_hw_init(void)
+{
+	const struct pio_desc dbgu_pins[] = {
+		{"RXD1", CONFIG_SYS_DBGU_RXD_PIN, 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"TXD1", CONFIG_SYS_DBGU_TXD_PIN, 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
+	};
+
+	pmc_sam9x5_enable_periph_clk(CONFIG_SYS_DBGU_ID);
+	*(volatile unsigned int*)AT91C_BASE_FLEXCOM1 = 1;
+	pio_configure(dbgu_pins);
+}
+
+static void initialize_dbgu(void)
+{
+	unsigned int baudrate = 9600;
+
+	at91_dbgu_hw_init();
+
+	if (pmc_check_mck_h32mxdiv())
+		usart_init(BAUDRATE(MASTER_CLOCK / 2, baudrate));
+	else
+		usart_init(BAUDRATE(MASTER_CLOCK, baudrate));
+}
+
+#if defined(CONFIG_MATRIX)
+static int matrix_configure_slave(void)
+{
+	unsigned int ddr_port;
+	unsigned int ssr_setting, sasplit_setting, srtop_setting;
+
+	/*
+	 * Matrix 0 (H64MX)
+	 */
+
+	/*
+	 * 0: Bridge from H64MX to AXIMX
+	 * (Internal ROM, Crypto Library, PKCC RAM): Always Secured
+	 */
+
+	/* 1: H64MX Peripheral Bridge */
+
+	/* 2 ~ 9 DDR2 Port1 ~ 7: Non-Secure */
+	srtop_setting = MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_128M);
+	sasplit_setting = (MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_128M)
+				| MATRIX_SASPLIT(1, MATRIX_SASPLIT_VALUE_128M)
+				| MATRIX_SASPLIT(2, MATRIX_SASPLIT_VALUE_128M)
+				| MATRIX_SASPLIT(3, MATRIX_SASPLIT_VALUE_128M));
+	ssr_setting = (MATRIX_LANSECH_NS(0)
+			| MATRIX_LANSECH_NS(1)
+			| MATRIX_LANSECH_NS(2)
+			| MATRIX_LANSECH_NS(3)
+			| MATRIX_RDNSECH_NS(0)
+			| MATRIX_RDNSECH_NS(1)
+			| MATRIX_RDNSECH_NS(2)
+			| MATRIX_RDNSECH_NS(3)
+			| MATRIX_WRNSECH_NS(0)
+			| MATRIX_WRNSECH_NS(1)
+			| MATRIX_WRNSECH_NS(2)
+			| MATRIX_WRNSECH_NS(3));
+	/* DDR port 0 not used from NWd */
+	for (ddr_port = 1; ddr_port < 8; ddr_port++) {
+		matrix_configure_slave_security(AT91C_BASE_MATRIX64,
+					(H64MX_SLAVE_DDR2_PORT_0 + ddr_port),
+					srtop_setting,
+					sasplit_setting,
+					ssr_setting);
+	}
+
+	/*
+	 * 10: Internal SRAM 128K
+	 * TOP0 is set to 128K
+	 * SPLIT0 is set to 64K
+	 * LANSECH0 is set to 0, the low area of region 0 is the Securable one
+	 * RDNSECH0 is set to 0, region 0 Securable area is secured for reads.
+	 * WRNSECH0 is set to 0, region 0 Securable area is secured for writes
+	 */
+	srtop_setting = MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_128K);
+	sasplit_setting = MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_64K);
+	ssr_setting = (MATRIX_LANSECH_S(0)
+			| MATRIX_RDNSECH_S(0)
+			| MATRIX_WRNSECH_S(0));
+	matrix_configure_slave_security(AT91C_BASE_MATRIX64,
+					H64MX_SLAVE_INTERNAL_SRAM,
+					srtop_setting,
+					sasplit_setting,
+					ssr_setting);
+
+	/* 11:  Internal SRAM 128K (Cache L2) */
+	/* 12:  QSPI0 */
+	/* 13:  QSPI1 */
+	/* 14:  AESB */
+
+	/*
+	 * Matrix 1 (H32MX)
+	 */
+
+	/* 0: Bridge from H32MX to H64MX: Not Secured */
+
+	/* 1: H32MX Peripheral Bridge 0: Not Secured */
+
+	/* 2: H32MX Peripheral Bridge 1: Not Secured */
+
+	/*
+	 * 3: External Bus Interface
+	 * EBI CS0 Memory(256M) ----> Slave Region 0, 1
+	 * EBI CS1 Memory(256M) ----> Slave Region 2, 3
+	 * EBI CS2 Memory(256M) ----> Slave Region 4, 5
+	 * EBI CS3 Memory(128M) ----> Slave Region 6
+	 * NFC Command Registers(128M) -->Slave Region 7
+	 *
+	 * NANDFlash(EBI CS3) --> Slave Region 6: Non-Secure
+	 */
+	srtop_setting =	MATRIX_SRTOP(6, MATRIX_SRTOP_VALUE_128M);
+	srtop_setting |= MATRIX_SRTOP(7, MATRIX_SRTOP_VALUE_128M);
+	sasplit_setting = MATRIX_SASPLIT(6, MATRIX_SASPLIT_VALUE_128M);
+	sasplit_setting |= MATRIX_SASPLIT(7, MATRIX_SASPLIT_VALUE_128M);
+	ssr_setting = (MATRIX_LANSECH_NS(6)
+			| MATRIX_RDNSECH_NS(6)
+			| MATRIX_WRNSECH_NS(6));
+	ssr_setting |= (MATRIX_LANSECH_NS(7)
+			| MATRIX_RDNSECH_NS(7)
+			| MATRIX_WRNSECH_NS(7));
+	matrix_configure_slave_security(AT91C_BASE_MATRIX32,
+					H32MX_EXTERNAL_EBI,
+					srtop_setting,
+					sasplit_setting,
+					ssr_setting);
+
+	/* 4: NFC SRAM (4K): Non-Secure */
+	srtop_setting = MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_8K);
+	sasplit_setting = MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_8K);
+	ssr_setting = (MATRIX_LANSECH_NS(0)
+			| MATRIX_RDNSECH_NS(0)
+			| MATRIX_WRNSECH_NS(0));
+	matrix_configure_slave_security(AT91C_BASE_MATRIX32,
+					H32MX_NFC_SRAM,
+					srtop_setting,
+					sasplit_setting,
+					ssr_setting);
+
+	/* 5:
+	 * USB Device High Speed Dual Port RAM (DPR): 1M
+	 * USB Host OHCI registers: 1M
+	 * USB Host EHCI registers: 1M
+	 */
+	srtop_setting = (MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_1M)
+			| MATRIX_SRTOP(1, MATRIX_SRTOP_VALUE_1M)
+			| MATRIX_SRTOP(2, MATRIX_SRTOP_VALUE_1M));
+	sasplit_setting = (MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_1M)
+			| MATRIX_SASPLIT(1, MATRIX_SASPLIT_VALUE_1M)
+			| MATRIX_SASPLIT(2, MATRIX_SASPLIT_VALUE_1M));
+	ssr_setting = (MATRIX_LANSECH_NS(0)
+			| MATRIX_LANSECH_NS(1)
+			| MATRIX_LANSECH_NS(2)
+			| MATRIX_RDNSECH_NS(0)
+			| MATRIX_RDNSECH_NS(1)
+			| MATRIX_RDNSECH_NS(2)
+			| MATRIX_WRNSECH_NS(0)
+			| MATRIX_WRNSECH_NS(1)
+			| MATRIX_WRNSECH_NS(2));
+	matrix_configure_slave_security(AT91C_BASE_MATRIX32,
+					H32MX_USB,
+					srtop_setting,
+					sasplit_setting,
+					ssr_setting);
+
+	return 0;
+}
+
+static unsigned int security_ps_peri_id[] = {
+	0,
+};
+
+static int matrix_config_periheral(void)
+{
+	unsigned int *peri_id = security_ps_peri_id;
+	unsigned int array_size = sizeof(security_ps_peri_id) / sizeof(unsigned int);
+	int ret;
+
+	ret = matrix_configure_peri_security(peri_id, array_size);
+	if (ret)
+		return -1;
+
+	return 0;
+}
+
+static int matrix_init(void)
+{
+	int ret;
+
+	matrix_write_protect_disable(AT91C_BASE_MATRIX64);
+	matrix_write_protect_disable(AT91C_BASE_MATRIX32);
+
+	ret = matrix_configure_slave();
+	if (ret)
+		return -1;
+
+	ret = matrix_config_periheral();
+	if (ret)
+		return -1;
+
+	return 0;
+}
+#endif
+
+static void ddramc_reg_config(struct ddramc_register* ddramc_config)
+{
+	ddramc_config->mdr = AT91C_DDRC2_DBW_16_BITS |
+			     AT91C_DDRC2_MD_DDR2_SDRAM;
+
+	ddramc_config->cr = AT91C_DDRC2_NC_DDR10_SDR9 |
+			    AT91C_DDRC2_NR_13 |
+			    AT91C_DDRC2_CAS_3 |
+			    AT91C_DDRC2_DISABLE_RESET_DLL |
+			    AT91C_DDRC2_WEAK_STRENGTH_RZQ7 |
+			    AT91C_DDRC2_ENABLE_DLL |
+			    AT91C_DDRC2_NB_BANKS_8 |
+			    AT91C_DDRC2_NDQS_ENABLED |
+			    AT91C_DDRC2_DECOD_INTERLEAVED |
+			    AT91C_DDRC2_UNAL_SUPPORTED;
+
+	ddramc_config->rtr = 0x388;
+
+	ddramc_config->t0pr = AT91C_DDRC2_TRAS_(7) |
+			      AT91C_DDRC2_TRCD_(3) |
+			      AT91C_DDRC2_TWR_(3) |
+			      AT91C_DDRC2_TRC_(9) |
+			      AT91C_DDRC2_TRP_(3) |
+			      AT91C_DDRC2_TRRD_(2) |
+			      AT91C_DDRC2_TWTR_(2) |
+			      AT91C_DDRC2_TMRD_(2);
+
+	ddramc_config->t1pr = AT91C_DDRC2_TRFC_(22) |
+			      AT91C_DDRC2_TXSNR_(23) |
+			      AT91C_DDRC2_TXSRD_(200) |
+			      AT91C_DDRC2_TXP_(2);
+
+	ddramc_config->t2pr = AT91C_DDRC2_TXARD_(2) |
+			      AT91C_DDRC2_TXARDS_(8) |
+			      AT91C_DDRC2_TRPA_(4) |
+			      AT91C_DDRC2_TRTP_(2) |
+			      AT91C_DDRC2_TFAW_(8);
+}
+
+
+static void ddramc_init(void)
+{
+	struct ddramc_register ddramc_reg;
+	unsigned int reg;
+
+	ddramc_reg_config(&ddramc_reg);
+
+	pmc_enable_periph_clock(AT91C_ID_MPDDRC);
+	pmc_enable_system_clock(AT91C_PMC_DDR);
+
+	reg = AT91C_MPDDRC_RD_DATA_PATH_ONE_CYCLES;
+	writel(reg, (AT91C_BASE_MPDDRC + MPDDRC_RD_DATA_PATH));
+
+	reg = readl(AT91C_BASE_MPDDRC + MPDDRC_IO_CALIBR);
+	reg &= ~AT91C_MPDDRC_RDIV;
+	reg &= ~AT91C_MPDDRC_TZQIO;
+	reg |= AT91C_MPDDRC_RDIV_DDR2_RZQ_50;
+	reg |= AT91C_MPDDRC_TZQIO_(101);
+	writel(reg, (AT91C_BASE_MPDDRC + MPDDRC_IO_CALIBR));
+
+	ddram_initialize(AT91C_BASE_MPDDRC, AT91C_BASE_DDRCS, &ddramc_reg);
+}
+
+
+/*static void init_prog_mode_hw(void)
+{
+	const struct pio_desc progmode_pins[] = {
+		{"PROGMODE_IN", AT91C_PIN_PD(26), 0, PIO_PULLUP, PIO_INPUT},
+		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
+	};
+
+	pio_configure(progmode_pins);
+}*/
+
+/*static void check_prog_mode_condition(void)
+{
+	if( pio_get_value(AT91C_PIN_PD(26)) )
+	{
+		dbg_info("--- NORMAL OPERATION ---\n");
+		return;
+	}
+
+	dbg_info("!!! I will now enter PROG MODE !!!\n");
+
+	*(volatile unsigned int*)0xF8045400 = (0xF << 12) | (1 << 11) | (1 << 10) | (3 << 8) | (3 << 6) | (3 << 4) | (3 << 2) | 3; //BUREG0
+	*(volatile unsigned int*)0xF8048054 = (0x6683 << 24) | (1 << 2) | 0; //BSC_CR
+	*(volatile unsigned int*)0xF8048000 = (0xA5 << 24) | 1; //reset
+	while(1);
+}*/
+
+
+#ifdef CONFIG_HW_INIT
+void hw_init(void)
+{
+	at91_disable_wdt();
+
+//	init_prog_mode_hw();
+
+	pmc_cfg_plla(PLLA_SETTINGS);
+	pmc_cfg_mck(BOARD_PRESCALER_PLLA);
+
+	writel(AT91C_RSTC_KEY_UNLOCK | AT91C_RSTC_URSTEN, AT91C_BASE_RSTC + RSTC_RMR);
+
+#if defined(CONFIG_MATRIX)
+	matrix_init();
+#endif
+
+	initialize_dbgu();
+//	check_prog_mode_condition();
+
+	timer_init();
+	ddramc_init();
+	l2cache_prepare();
+}
+#endif
+
+#ifdef CONFIG_SDCARD
+#define ATMEL_SDHC_GCKDIV_VALUE		1
+
+#define SDMMC_CACR		(((volatile unsigned*)AT91C_BASE_SDHC0)[0x230/sizeof(unsigned)])
+#define SDMMC_CACR_UNLOCK_VAL	((0x46 << 8) | 1)
+#define SDMMC_CACR_LOCK_VAL	((0x46 << 8) | 0)
+
+#define SDMMC_CA0R		(((volatile unsigned*)AT91C_BASE_SDHC0)[0x40/sizeof(unsigned)])
+#define SDMMC_CA0R_SLTYPE(x)	((x) << 30)
+#define SDMMC_CA0R_SUP1V8	(1 << 26)
+#define SDMMC_CA0R_SUP3V3	(1 << 24)
+
+#define SDMMC_MC1R		(((volatile unsigned char*)AT91C_BASE_SDHC0)[0x204])
+#define SDMMC_MC1R_FCD		(1 << 7)
+
+void at91_sdhc_hw_init(void)
+{
+#ifdef CONFIG_SDHC0
+	const struct pio_desc sdmmc_pins[] = {
+		{"SDMMC0_CK",   AT91C_PIN_PA(0), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_CMD",  AT91C_PIN_PA(1), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT0", AT91C_PIN_PA(2), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT1", AT91C_PIN_PA(3), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT2", AT91C_PIN_PA(4), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT3", AT91C_PIN_PA(5), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT4", AT91C_PIN_PA(6), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT5", AT91C_PIN_PA(7), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT6", AT91C_PIN_PA(8), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_DAT7", AT91C_PIN_PA(9), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_RSTN", AT91C_PIN_PA(10), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"SDMMC0_VDDSEL", AT91C_PIN_PA(11), 0, PIO_DEFAULT, PIO_PERIPH_A},
+//		{"SDMMC0_WP",   AT91C_PIN_PA(12), 0, PIO_DEFAULT, PIO_PERIPH_A},
+//		{"SDMMC0_CD",   AT91C_PIN_PA(13), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
+	};
+#endif
+
+	pio_configure(sdmmc_pins);
+
+	pmc_sam9x5_enable_periph_clk(CONFIG_SYS_ID_SDHC);
+	pmc_enable_periph_generated_clk(CONFIG_SYS_ID_SDHC,
+					GCK_CSS_UPLL_CLK,
+					ATMEL_SDHC_GCKDIV_VALUE);
+	SDMMC_CACR = SDMMC_CACR_UNLOCK_VAL;
+	SDMMC_CA0R |= SDMMC_CA0R_SLTYPE(1) | SDMMC_CA0R_SUP1V8 | SDMMC_CA0R_SUP3V3;
+	SDMMC_CACR = SDMMC_CACR_LOCK_VAL;
+	SDMMC_MC1R |= SDMMC_MC1R_FCD;	//force CD for eMMC
+}
+#endif
+
+#if defined(CONFIG_TWI0)
+unsigned int at91_twi0_hw_init(void)
+{
+	unsigned int base_addr = AT91C_BASE_TWI0;
+
+	const struct pio_desc twi_pins[] = {
+		{"TWD0", AT91C_PIN_PC(27), 0, PIO_DEFAULT, PIO_PERIPH_E},
+		{"TWCK0", AT91C_PIN_PC(28), 0, PIO_DEFAULT, PIO_PERIPH_E},
+		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
+	};
+
+	pio_configure(twi_pins);
+
+	pmc_sam9x5_enable_periph_clk(AT91C_ID_TWI0);
+
+	return base_addr;
+}
+#endif
+
+#if defined(CONFIG_TWI1)
+unsigned int at91_twi1_hw_init(void)
+{
+	const struct pio_desc twi_pins[] = {
+		{"TWD1", AT91C_PIN_PD(4), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{"TWCK1", AT91C_PIN_PD(5), 0, PIO_DEFAULT, PIO_PERIPH_A},
+		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
+	};
+
+	pio_configure(twi_pins);
+
+	pmc_sam9x5_enable_periph_clk(AT91C_ID_TWI1);
+
+	return AT91C_BASE_TWI1;
+}
+#endif
+
+#if defined(CONFIG_AUTOCONFIG_TWI_BUS)
+void at91_board_config_twi_bus(void)
+{
+	act8865_twi_bus = 0;
+}
+#endif
+
+#if defined(CONFIG_ACT8865_SET_VOLTAGE)
+int at91_board_act8865_set_reg_voltage(void)
+{
+	return 0;
+}
+#endif
diff --git a/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.h b/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.h
new file mode 100644
index 0000000..3c1a145
--- /dev/null
+++ b/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.h
@@ -0,0 +1,46 @@
+#ifndef __P_A5_TAB_REVA_H
+#define __P_A5_TAB_REVA_H
+
+
+#ifdef CONFIG_BUS_SPEED_166MHZ
+#define MASTER_CLOCK		166000000
+#define BOARD_PLLA_MULA		82
+#endif
+
+#ifdef CONFIG_BUS_SPEED_116MHZ
+#define MASTER_CLOCK		116000000
+#define BOARD_PLLA_MULA		57
+#endif
+
+
+#define BOARD_CKGR_PLLA		(AT91C_CKGR_SRCA | AT91C_CKGR_OUTA_0)
+#define BOARD_PLLACOUNT		(0x3F << 8)
+#define BOARD_MULA		((AT91C_CKGR_MULA << 2) & (BOARD_PLLA_MULA << 18))
+#define BOARD_DIVA		(AT91C_CKGR_DIVA & 1)
+
+/*#define BOARD_PRESCALER_MAIN_CLOCK	(AT91C_PMC_PLLADIV2_2 \
+					| AT91C_PMC_MDIV_3 \
+					| AT91C_PMC_CSS_MAIN_CLK)*/
+
+#define BOARD_PRESCALER_PLLA		(AT91C_PMC_H32MXDIV_H32MXDIV2 \
+					| AT91C_PMC_PLLADIV2_2 \
+					| AT91C_PMC_MDIV_3 \
+					| AT91C_PMC_CSS_PLLA_CLK)
+
+#define PLLA_SETTINGS		(BOARD_CKGR_PLLA | \
+				BOARD_PLLACOUNT | \
+				BOARD_MULA | \
+				BOARD_DIVA)
+
+
+#define USART_BASE			(AT91C_BASE_FLEXCOM1 + 0x0200)
+#define CONFIG_SYS_DBGU_RXD_PIN		AT91C_PIN_PA(23)
+#define CONFIG_SYS_DBGU_TXD_PIN		AT91C_PIN_PA(24)
+#define CONFIG_SYS_DBGU_ID		AT91C_ID_FLEXCOM1
+
+
+#define CONFIG_SYS_BASE_SDHC	AT91C_BASE_SDHC0
+#define CONFIG_SYS_ID_SDHC	AT91C_ID_SDMMC0
+
+
+#endif
diff --git a/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_revaemmc_defconfig b/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_revaemmc_defconfig
new file mode 100644
index 0000000..e4ef412
--- /dev/null
+++ b/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_revaemmc_defconfig
@@ -0,0 +1,10 @@
+CONFIG_P_A5_TAB_REVA=y
+CONFIG_RAM_128MB=y
+CONFIG_DDR2=y
+CONFIG_SDCARD=y
+CONFIG_SDHC0=y
+CONFIG_DEBUG=y
+CONFIG_ACT8865=y
+CONFIG_PMIC_ON_TWI0=y
+# CONFIG_ENTER_NWD is not set
+# CONFIG_ACT8865_SET_VOLTAGE is not set
diff --git a/contrib/board/Config.in.board b/contrib/board/Config.in.board
index a12037c..9fb579d 100644
--- a/contrib/board/Config.in.board
+++ b/contrib/board/Config.in.board
@@ -8,4 +8,4 @@ source "contrib/board/acme/sama5d3_acqua/Config.in.board"
 source "contrib/board/acme/sama5d2_roadrunner/Config.in.board"
 source "contrib/board/corewind/core9g25/Config.in.board"
 source "contrib/board/axentia/sama5d3_linea/Config.in.board"
-source "contrib/board/p_a5_tab_reva/Config.in.board"
+source "contrib/board/A.R.f./p_a5_tab_reva/Config.in.board"
diff --git a/contrib/board/Config.in.boardname b/contrib/board/Config.in.boardname
index c8ed3f9..a067e7b 100644
--- a/contrib/board/Config.in.boardname
+++ b/contrib/board/Config.in.boardname
@@ -8,4 +8,4 @@ source "contrib/board/acme/sama5d3_acqua/Config.in.boardname"
 source "contrib/board/acme/sama5d2_roadrunner/Config.in.boardname"
 source "contrib/board/corewind/core9g25/Config.in.boardname"
 source "contrib/board/axentia/sama5d3_linea/Config.in.boardname"
-source "contrib/board/p_a5_tab_reva/Config.in.boardname"
+source "contrib/board/A.R.f./p_a5_tab_reva/Config.in.boardname"
diff --git a/contrib/board/Config.in.linux_arg b/contrib/board/Config.in.linux_arg
index b580d53..5796e92 100644
--- a/contrib/board/Config.in.linux_arg
+++ b/contrib/board/Config.in.linux_arg
@@ -8,3 +8,4 @@ source "contrib/board/acme/sama5d3_acqua/Config.in.linux_arg"
 source "contrib/board/acme/sama5d2_roadrunner/Config.in.linux_arg"
 source "contrib/board/corewind/core9g25/Config.in.linux_arg"
 source "contrib/board/axentia/sama5d3_linea/Config.in.linux_arg"
+source "contrib/board/A.R.f./p_a5_tab_reva/Config.in.linux_arg"
diff --git a/contrib/board/p_a5_tab_reva/Config.in.board b/contrib/board/p_a5_tab_reva/Config.in.board
deleted file mode 100644
index 3b75f90..0000000
--- a/contrib/board/p_a5_tab_reva/Config.in.board
+++ /dev/null
@@ -1,14 +0,0 @@
-config CONFIG_P_A5_TAB_REVA
-	bool "p_a5_tab_reva"
-	select SAMA5D2
-	select CONFIG_CPU_V7
-	select CONFIG_DDRC
-	select ALLOW_SDCARD
-	select ALLOW_CPU_CLK_348MHZ
-	select ALLOW_CPU_CLK_498MHZ
-	select ALLOW_CRYSTAL_12_000MHZ
-	select CONFIG_HAS_PMIC_ACT8865
-	select SUPPORT_BUS_SPEED_116MHZ
-	select SUPPORT_BUS_SPEED_166MHZ
-	help
-		Use the P-A5-TAB RevA board
diff --git a/contrib/board/p_a5_tab_reva/Config.in.boardname b/contrib/board/p_a5_tab_reva/Config.in.boardname
deleted file mode 100644
index f2cc9e8..0000000
--- a/contrib/board/p_a5_tab_reva/Config.in.boardname
+++ /dev/null
@@ -1,2 +0,0 @@
-config CONFIG_BOARDNAME
-	default "p_a5_tab_reva"		if CONFIG_P_A5_TAB_REVA
diff --git a/contrib/board/p_a5_tab_reva/board.mk b/contrib/board/p_a5_tab_reva/board.mk
deleted file mode 100644
index ca5957f..0000000
--- a/contrib/board/p_a5_tab_reva/board.mk
+++ /dev/null
@@ -1,2 +0,0 @@
-CPPFLAGS += -DCONFIG_P_A5_TAB_REVA
-ASFLAGS += -DCONFIG_P_A5_TAB_REVA
diff --git a/contrib/board/p_a5_tab_reva/p_a5_tab_reva.c b/contrib/board/p_a5_tab_reva/p_a5_tab_reva.c
deleted file mode 100644
index 49d8f18..0000000
--- a/contrib/board/p_a5_tab_reva/p_a5_tab_reva.c
+++ /dev/null
@@ -1,441 +0,0 @@
-#include "p_a5_tab_reva.h"
-#include "common.h"
-#include "ddramc.h"
-#include "debug.h"
-#include "gpio.h"
-#include "hardware.h"
-#include "l2cc.h"
-#include "matrix.h"
-#include "pmc.h"
-#include "timer.h"
-#include "twi.h"
-#include "usart.h"
-#include "watchdog.h"
-#include "arch/at91_ddrsdrc.h"
-#include "arch/at91_pio.h"
-#include "arch/at91_pmc.h"
-#include "arch/at91_rstc.h"
-#include "arch/tz_matrix.h"
-
-
-static void at91_dbgu_hw_init(void)
-{
-	const struct pio_desc dbgu_pins[] = {
-		{"RXD1", CONFIG_SYS_DBGU_RXD_PIN, 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"TXD1", CONFIG_SYS_DBGU_TXD_PIN, 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
-	};
-
-	pmc_sam9x5_enable_periph_clk(CONFIG_SYS_DBGU_ID);
-	*(volatile unsigned int*)AT91C_BASE_FLEXCOM1 = 1;
-	pio_configure(dbgu_pins);
-}
-
-static void initialize_dbgu(void)
-{
-	unsigned int baudrate = 9600;
-
-	at91_dbgu_hw_init();
-
-	if (pmc_check_mck_h32mxdiv())
-		usart_init(BAUDRATE(MASTER_CLOCK / 2, baudrate));
-	else
-		usart_init(BAUDRATE(MASTER_CLOCK, baudrate));
-}
-
-#if defined(CONFIG_MATRIX)
-static int matrix_configure_slave(void)
-{
-	unsigned int ddr_port;
-	unsigned int ssr_setting, sasplit_setting, srtop_setting;
-
-	/*
-	 * Matrix 0 (H64MX)
-	 */
-
-	/*
-	 * 0: Bridge from H64MX to AXIMX
-	 * (Internal ROM, Crypto Library, PKCC RAM): Always Secured
-	 */
-
-	/* 1: H64MX Peripheral Bridge */
-
-	/* 2 ~ 9 DDR2 Port1 ~ 7: Non-Secure */
-	srtop_setting = MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_128M);
-	sasplit_setting = (MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_128M)
-				| MATRIX_SASPLIT(1, MATRIX_SASPLIT_VALUE_128M)
-				| MATRIX_SASPLIT(2, MATRIX_SASPLIT_VALUE_128M)
-				| MATRIX_SASPLIT(3, MATRIX_SASPLIT_VALUE_128M));
-	ssr_setting = (MATRIX_LANSECH_NS(0)
-			| MATRIX_LANSECH_NS(1)
-			| MATRIX_LANSECH_NS(2)
-			| MATRIX_LANSECH_NS(3)
-			| MATRIX_RDNSECH_NS(0)
-			| MATRIX_RDNSECH_NS(1)
-			| MATRIX_RDNSECH_NS(2)
-			| MATRIX_RDNSECH_NS(3)
-			| MATRIX_WRNSECH_NS(0)
-			| MATRIX_WRNSECH_NS(1)
-			| MATRIX_WRNSECH_NS(2)
-			| MATRIX_WRNSECH_NS(3));
-	/* DDR port 0 not used from NWd */
-	for (ddr_port = 1; ddr_port < 8; ddr_port++) {
-		matrix_configure_slave_security(AT91C_BASE_MATRIX64,
-					(H64MX_SLAVE_DDR2_PORT_0 + ddr_port),
-					srtop_setting,
-					sasplit_setting,
-					ssr_setting);
-	}
-
-	/*
-	 * 10: Internal SRAM 128K
-	 * TOP0 is set to 128K
-	 * SPLIT0 is set to 64K
-	 * LANSECH0 is set to 0, the low area of region 0 is the Securable one
-	 * RDNSECH0 is set to 0, region 0 Securable area is secured for reads.
-	 * WRNSECH0 is set to 0, region 0 Securable area is secured for writes
-	 */
-	srtop_setting = MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_128K);
-	sasplit_setting = MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_64K);
-	ssr_setting = (MATRIX_LANSECH_S(0)
-			| MATRIX_RDNSECH_S(0)
-			| MATRIX_WRNSECH_S(0));
-	matrix_configure_slave_security(AT91C_BASE_MATRIX64,
-					H64MX_SLAVE_INTERNAL_SRAM,
-					srtop_setting,
-					sasplit_setting,
-					ssr_setting);
-
-	/* 11:  Internal SRAM 128K (Cache L2) */
-	/* 12:  QSPI0 */
-	/* 13:  QSPI1 */
-	/* 14:  AESB */
-
-	/*
-	 * Matrix 1 (H32MX)
-	 */
-
-	/* 0: Bridge from H32MX to H64MX: Not Secured */
-
-	/* 1: H32MX Peripheral Bridge 0: Not Secured */
-
-	/* 2: H32MX Peripheral Bridge 1: Not Secured */
-
-	/*
-	 * 3: External Bus Interface
-	 * EBI CS0 Memory(256M) ----> Slave Region 0, 1
-	 * EBI CS1 Memory(256M) ----> Slave Region 2, 3
-	 * EBI CS2 Memory(256M) ----> Slave Region 4, 5
-	 * EBI CS3 Memory(128M) ----> Slave Region 6
-	 * NFC Command Registers(128M) -->Slave Region 7
-	 *
-	 * NANDFlash(EBI CS3) --> Slave Region 6: Non-Secure
-	 */
-	srtop_setting =	MATRIX_SRTOP(6, MATRIX_SRTOP_VALUE_128M);
-	srtop_setting |= MATRIX_SRTOP(7, MATRIX_SRTOP_VALUE_128M);
-	sasplit_setting = MATRIX_SASPLIT(6, MATRIX_SASPLIT_VALUE_128M);
-	sasplit_setting |= MATRIX_SASPLIT(7, MATRIX_SASPLIT_VALUE_128M);
-	ssr_setting = (MATRIX_LANSECH_NS(6)
-			| MATRIX_RDNSECH_NS(6)
-			| MATRIX_WRNSECH_NS(6));
-	ssr_setting |= (MATRIX_LANSECH_NS(7)
-			| MATRIX_RDNSECH_NS(7)
-			| MATRIX_WRNSECH_NS(7));
-	matrix_configure_slave_security(AT91C_BASE_MATRIX32,
-					H32MX_EXTERNAL_EBI,
-					srtop_setting,
-					sasplit_setting,
-					ssr_setting);
-
-	/* 4: NFC SRAM (4K): Non-Secure */
-	srtop_setting = MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_8K);
-	sasplit_setting = MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_8K);
-	ssr_setting = (MATRIX_LANSECH_NS(0)
-			| MATRIX_RDNSECH_NS(0)
-			| MATRIX_WRNSECH_NS(0));
-	matrix_configure_slave_security(AT91C_BASE_MATRIX32,
-					H32MX_NFC_SRAM,
-					srtop_setting,
-					sasplit_setting,
-					ssr_setting);
-
-	/* 5:
-	 * USB Device High Speed Dual Port RAM (DPR): 1M
-	 * USB Host OHCI registers: 1M
-	 * USB Host EHCI registers: 1M
-	 */
-	srtop_setting = (MATRIX_SRTOP(0, MATRIX_SRTOP_VALUE_1M)
-			| MATRIX_SRTOP(1, MATRIX_SRTOP_VALUE_1M)
-			| MATRIX_SRTOP(2, MATRIX_SRTOP_VALUE_1M));
-	sasplit_setting = (MATRIX_SASPLIT(0, MATRIX_SASPLIT_VALUE_1M)
-			| MATRIX_SASPLIT(1, MATRIX_SASPLIT_VALUE_1M)
-			| MATRIX_SASPLIT(2, MATRIX_SASPLIT_VALUE_1M));
-	ssr_setting = (MATRIX_LANSECH_NS(0)
-			| MATRIX_LANSECH_NS(1)
-			| MATRIX_LANSECH_NS(2)
-			| MATRIX_RDNSECH_NS(0)
-			| MATRIX_RDNSECH_NS(1)
-			| MATRIX_RDNSECH_NS(2)
-			| MATRIX_WRNSECH_NS(0)
-			| MATRIX_WRNSECH_NS(1)
-			| MATRIX_WRNSECH_NS(2));
-	matrix_configure_slave_security(AT91C_BASE_MATRIX32,
-					H32MX_USB,
-					srtop_setting,
-					sasplit_setting,
-					ssr_setting);
-
-	return 0;
-}
-
-static unsigned int security_ps_peri_id[] = {
-	0,
-};
-
-static int matrix_config_periheral(void)
-{
-	unsigned int *peri_id = security_ps_peri_id;
-	unsigned int array_size = sizeof(security_ps_peri_id) / sizeof(unsigned int);
-	int ret;
-
-	ret = matrix_configure_peri_security(peri_id, array_size);
-	if (ret)
-		return -1;
-
-	return 0;
-}
-
-static int matrix_init(void)
-{
-	int ret;
-
-	matrix_write_protect_disable(AT91C_BASE_MATRIX64);
-	matrix_write_protect_disable(AT91C_BASE_MATRIX32);
-
-	ret = matrix_configure_slave();
-	if (ret)
-		return -1;
-
-	ret = matrix_config_periheral();
-	if (ret)
-		return -1;
-
-	return 0;
-}
-#endif
-
-static void ddramc_reg_config(struct ddramc_register* ddramc_config)
-{
-	ddramc_config->mdr = AT91C_DDRC2_DBW_16_BITS |
-			     AT91C_DDRC2_MD_DDR2_SDRAM;
-
-	ddramc_config->cr = AT91C_DDRC2_NC_DDR10_SDR9 |
-			    AT91C_DDRC2_NR_13 |
-			    AT91C_DDRC2_CAS_3 |
-			    AT91C_DDRC2_DISABLE_RESET_DLL |
-			    AT91C_DDRC2_WEAK_STRENGTH_RZQ7 |
-			    AT91C_DDRC2_ENABLE_DLL |
-			    AT91C_DDRC2_NB_BANKS_8 |
-			    AT91C_DDRC2_NDQS_ENABLED |
-			    AT91C_DDRC2_DECOD_INTERLEAVED |
-			    AT91C_DDRC2_UNAL_SUPPORTED;
-
-	ddramc_config->rtr = 0x388;
-
-	ddramc_config->t0pr = AT91C_DDRC2_TRAS_(7) |
-			      AT91C_DDRC2_TRCD_(3) |
-			      AT91C_DDRC2_TWR_(3) |
-			      AT91C_DDRC2_TRC_(9) |
-			      AT91C_DDRC2_TRP_(3) |
-			      AT91C_DDRC2_TRRD_(2) |
-			      AT91C_DDRC2_TWTR_(2) |
-			      AT91C_DDRC2_TMRD_(2);
-
-	ddramc_config->t1pr = AT91C_DDRC2_TRFC_(22) |
-			      AT91C_DDRC2_TXSNR_(23) |
-			      AT91C_DDRC2_TXSRD_(200) |
-			      AT91C_DDRC2_TXP_(2);
-
-	ddramc_config->t2pr = AT91C_DDRC2_TXARD_(2) |
-			      AT91C_DDRC2_TXARDS_(8) |
-			      AT91C_DDRC2_TRPA_(4) |
-			      AT91C_DDRC2_TRTP_(2) |
-			      AT91C_DDRC2_TFAW_(8);
-}
-
-
-static void ddramc_init(void)
-{
-	struct ddramc_register ddramc_reg;
-	unsigned int reg;
-
-	ddramc_reg_config(&ddramc_reg);
-
-	pmc_enable_periph_clock(AT91C_ID_MPDDRC);
-	pmc_enable_system_clock(AT91C_PMC_DDR);
-
-	reg = AT91C_MPDDRC_RD_DATA_PATH_ONE_CYCLES;
-	writel(reg, (AT91C_BASE_MPDDRC + MPDDRC_RD_DATA_PATH));
-
-	reg = readl(AT91C_BASE_MPDDRC + MPDDRC_IO_CALIBR);
-	reg &= ~AT91C_MPDDRC_RDIV;
-	reg &= ~AT91C_MPDDRC_TZQIO;
-	reg |= AT91C_MPDDRC_RDIV_DDR2_RZQ_50;
-	reg |= AT91C_MPDDRC_TZQIO_(101);
-	writel(reg, (AT91C_BASE_MPDDRC + MPDDRC_IO_CALIBR));
-
-	ddram_initialize(AT91C_BASE_MPDDRC, AT91C_BASE_DDRCS, &ddramc_reg);
-}
-
-
-/*static void init_prog_mode_hw(void)
-{
-	const struct pio_desc progmode_pins[] = {
-		{"PROGMODE_IN", AT91C_PIN_PD(26), 0, PIO_PULLUP, PIO_INPUT},
-		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
-	};
-
-	pio_configure(progmode_pins);
-}*/
-
-/*static void check_prog_mode_condition(void)
-{
-	if( pio_get_value(AT91C_PIN_PD(26)) )
-	{
-		dbg_info("--- NORMAL OPERATION ---\n");
-		return;
-	}
-
-	dbg_info("!!! I will now enter PROG MODE !!!\n");
-
-	*(volatile unsigned int*)0xF8045400 = (0xF << 12) | (1 << 11) | (1 << 10) | (3 << 8) | (3 << 6) | (3 << 4) | (3 << 2) | 3; //BUREG0
-	*(volatile unsigned int*)0xF8048054 = (0x6683 << 24) | (1 << 2) | 0; //BSC_CR
-	*(volatile unsigned int*)0xF8048000 = (0xA5 << 24) | 1; //reset
-	while(1);
-}*/
-
-
-#ifdef CONFIG_HW_INIT
-void hw_init(void)
-{
-	at91_disable_wdt();
-
-//	init_prog_mode_hw();
-
-	pmc_cfg_plla(PLLA_SETTINGS);
-	pmc_cfg_mck(BOARD_PRESCALER_PLLA);
-
-	writel(AT91C_RSTC_KEY_UNLOCK | AT91C_RSTC_URSTEN, AT91C_BASE_RSTC + RSTC_RMR);
-
-#if defined(CONFIG_MATRIX)
-	matrix_init();
-#endif
-
-	initialize_dbgu();
-//	check_prog_mode_condition();
-
-	timer_init();
-	ddramc_init();
-	l2cache_prepare();
-}
-#endif
-
-#ifdef CONFIG_SDCARD
-#define ATMEL_SDHC_GCKDIV_VALUE		1
-
-#define SDMMC_CACR		(((volatile unsigned*)AT91C_BASE_SDHC0)[0x230/sizeof(unsigned)])
-#define SDMMC_CACR_UNLOCK_VAL	((0x46 << 8) | 1)
-#define SDMMC_CACR_LOCK_VAL	((0x46 << 8) | 0)
-
-#define SDMMC_CA0R		(((volatile unsigned*)AT91C_BASE_SDHC0)[0x40/sizeof(unsigned)])
-#define SDMMC_CA0R_SLTYPE(x)	((x) << 30)
-#define SDMMC_CA0R_SUP1V8	(1 << 26)
-#define SDMMC_CA0R_SUP3V3	(1 << 24)
-
-#define SDMMC_MC1R		(((volatile unsigned char*)AT91C_BASE_SDHC0)[0x204])
-#define SDMMC_MC1R_FCD		(1 << 7)
-
-void at91_sdhc_hw_init(void)
-{
-#ifdef CONFIG_SDHC0
-	const struct pio_desc sdmmc_pins[] = {
-		{"SDMMC0_CK",   AT91C_PIN_PA(0), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_CMD",  AT91C_PIN_PA(1), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_DAT0", AT91C_PIN_PA(2), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_DAT1", AT91C_PIN_PA(3), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_DAT2", AT91C_PIN_PA(4), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_DAT3", AT91C_PIN_PA(5), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_DAT4", AT91C_PIN_PA(6), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_DAT5", AT91C_PIN_PA(7), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_DAT6", AT91C_PIN_PA(8), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_DAT7", AT91C_PIN_PA(9), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_RSTN", AT91C_PIN_PA(10), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"SDMMC0_VDDSEL", AT91C_PIN_PA(11), 0, PIO_DEFAULT, PIO_PERIPH_A},
-//		{"SDMMC0_WP",   AT91C_PIN_PA(12), 0, PIO_DEFAULT, PIO_PERIPH_A},
-//		{"SDMMC0_CD",   AT91C_PIN_PA(13), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
-	};
-#endif
-
-	pio_configure(sdmmc_pins);
-
-	pmc_sam9x5_enable_periph_clk(CONFIG_SYS_ID_SDHC);
-	pmc_enable_periph_generated_clk(CONFIG_SYS_ID_SDHC,
-					GCK_CSS_UPLL_CLK,
-					ATMEL_SDHC_GCKDIV_VALUE);
-	SDMMC_CACR = SDMMC_CACR_UNLOCK_VAL;
-	SDMMC_CA0R |= SDMMC_CA0R_SLTYPE(1) | SDMMC_CA0R_SUP1V8 | SDMMC_CA0R_SUP3V3;
-	SDMMC_CACR = SDMMC_CACR_LOCK_VAL;
-	SDMMC_MC1R |= SDMMC_MC1R_FCD;	//force CD for eMMC
-}
-#endif
-
-#if defined(CONFIG_TWI0)
-unsigned int at91_twi0_hw_init(void)
-{
-	unsigned int base_addr = AT91C_BASE_TWI0;
-
-	const struct pio_desc twi_pins[] = {
-		{"TWD0", AT91C_PIN_PC(27), 0, PIO_DEFAULT, PIO_PERIPH_E},
-		{"TWCK0", AT91C_PIN_PC(28), 0, PIO_DEFAULT, PIO_PERIPH_E},
-		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
-	};
-
-	pio_configure(twi_pins);
-
-	pmc_sam9x5_enable_periph_clk(AT91C_ID_TWI0);
-
-	return base_addr;
-}
-#endif
-
-#if defined(CONFIG_TWI1)
-unsigned int at91_twi1_hw_init(void)
-{
-	const struct pio_desc twi_pins[] = {
-		{"TWD1", AT91C_PIN_PD(4), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{"TWCK1", AT91C_PIN_PD(5), 0, PIO_DEFAULT, PIO_PERIPH_A},
-		{(char *)0, 0, 0, PIO_DEFAULT, PIO_PERIPH_A},
-	};
-
-	pio_configure(twi_pins);
-
-	pmc_sam9x5_enable_periph_clk(AT91C_ID_TWI1);
-
-	return AT91C_BASE_TWI1;
-}
-#endif
-
-#if defined(CONFIG_AUTOCONFIG_TWI_BUS)
-void at91_board_config_twi_bus(void)
-{
-	act8865_twi_bus = 0;
-}
-#endif
-
-#if defined(CONFIG_ACT8865_SET_VOLTAGE)
-int at91_board_act8865_set_reg_voltage(void)
-{
-	return 0;
-}
-#endif
diff --git a/contrib/board/p_a5_tab_reva/p_a5_tab_reva.h b/contrib/board/p_a5_tab_reva/p_a5_tab_reva.h
deleted file mode 100644
index 3c1a145..0000000
--- a/contrib/board/p_a5_tab_reva/p_a5_tab_reva.h
+++ /dev/null
@@ -1,46 +0,0 @@
-#ifndef __P_A5_TAB_REVA_H
-#define __P_A5_TAB_REVA_H
-
-
-#ifdef CONFIG_BUS_SPEED_166MHZ
-#define MASTER_CLOCK		166000000
-#define BOARD_PLLA_MULA		82
-#endif
-
-#ifdef CONFIG_BUS_SPEED_116MHZ
-#define MASTER_CLOCK		116000000
-#define BOARD_PLLA_MULA		57
-#endif
-
-
-#define BOARD_CKGR_PLLA		(AT91C_CKGR_SRCA | AT91C_CKGR_OUTA_0)
-#define BOARD_PLLACOUNT		(0x3F << 8)
-#define BOARD_MULA		((AT91C_CKGR_MULA << 2) & (BOARD_PLLA_MULA << 18))
-#define BOARD_DIVA		(AT91C_CKGR_DIVA & 1)
-
-/*#define BOARD_PRESCALER_MAIN_CLOCK	(AT91C_PMC_PLLADIV2_2 \
-					| AT91C_PMC_MDIV_3 \
-					| AT91C_PMC_CSS_MAIN_CLK)*/
-
-#define BOARD_PRESCALER_PLLA		(AT91C_PMC_H32MXDIV_H32MXDIV2 \
-					| AT91C_PMC_PLLADIV2_2 \
-					| AT91C_PMC_MDIV_3 \
-					| AT91C_PMC_CSS_PLLA_CLK)
-
-#define PLLA_SETTINGS		(BOARD_CKGR_PLLA | \
-				BOARD_PLLACOUNT | \
-				BOARD_MULA | \
-				BOARD_DIVA)
-
-
-#define USART_BASE			(AT91C_BASE_FLEXCOM1 + 0x0200)
-#define CONFIG_SYS_DBGU_RXD_PIN		AT91C_PIN_PA(23)
-#define CONFIG_SYS_DBGU_TXD_PIN		AT91C_PIN_PA(24)
-#define CONFIG_SYS_DBGU_ID		AT91C_ID_FLEXCOM1
-
-
-#define CONFIG_SYS_BASE_SDHC	AT91C_BASE_SDHC0
-#define CONFIG_SYS_ID_SDHC	AT91C_ID_SDMMC0
-
-
-#endif
diff --git a/contrib/board/p_a5_tab_reva/p_a5_tab_revaemmc_defconfig b/contrib/board/p_a5_tab_reva/p_a5_tab_revaemmc_defconfig
deleted file mode 100644
index e4ef412..0000000
--- a/contrib/board/p_a5_tab_reva/p_a5_tab_revaemmc_defconfig
+++ /dev/null
@@ -1,10 +0,0 @@
-CONFIG_P_A5_TAB_REVA=y
-CONFIG_RAM_128MB=y
-CONFIG_DDR2=y
-CONFIG_SDCARD=y
-CONFIG_SDHC0=y
-CONFIG_DEBUG=y
-CONFIG_ACT8865=y
-CONFIG_PMIC_ON_TWI0=y
-# CONFIG_ENTER_NWD is not set
-# CONFIG_ACT8865_SET_VOLTAGE is not set
-- 
2.1.4


From c7005b0852953eb824947e40c51fcbd2a69ef509 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Adam=20Rudzi=C5=84ski?= <devel@arf.net.pl>
Date: Sat, 3 Feb 2018 13:34:45 +0100
Subject: [PATCH 4/4] UART 115200

---
 contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.c b/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.c
index 49d8f18..af1d141 100644
--- a/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.c
+++ b/contrib/board/A.R.f./p_a5_tab_reva/p_a5_tab_reva.c
@@ -33,7 +33,7 @@ static void at91_dbgu_hw_init(void)
 
 static void initialize_dbgu(void)
 {
-	unsigned int baudrate = 9600;
+	const unsigned int baudrate = 115200;
 
 	at91_dbgu_hw_init();
 
-- 
2.1.4

